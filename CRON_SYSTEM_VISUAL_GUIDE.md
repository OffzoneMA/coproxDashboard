# Cron System Architecture - Visual Guide

## System Overview

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    CoproxDashboard Cron System                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

        Two Independent Execution Systems

โโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  AUTOMATED CRON          โ     โ  MANUAL EXECUTION         โ
โ  (Scheduled)             โ     โ  (User-Triggered)         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## System 1: Automated Cron Execution

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   MongoDB CronConfig                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ morning-sync-3am                                    โ   โ
โ  โ schedule: "0 3 * * *"                               โ   โ
โ  โ enabled: true                                       โ   โ
โ  โ scripts:                                            โ   โ
โ  โ   - synchroFacture                                  โ   โ
โ  โ   - zendeskTicket                                   โ   โ
โ  โ   - synchroRapelles                                 โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                    โฐ 3:00 AM UTC
                            โ
              โโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ  cronStart.js           โ
              โ  executeCronScripts()   โ
              โโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
              โโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ executeScheduledScript()โ
              โ [SCHEDULED] prefix      โ
              โโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                    Run script.start()
                            โ
              โโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ  Log execution history  โ
              โ  โ No status updates    โ
              โโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## System 2: Manual Execution

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      User Interface                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  Script: synchroFacture                             โ   โ
โ  โ  Status: Success (0)                                โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ   โ
โ  โ  โ  [Lancer Manuellement] ๐                  โ    โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
              POST /script/update-status
                    { status: 1 }
                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    MongoDB ScriptState                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  name: "synchroFacture"                             โ   โ
โ  โ  status: 1  โ WAITING TO START                      โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
              โฑ๏ธ Wait up to 5 minutes
                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         Cron: "every-5-minutes" (*/5 * * * *)               โ
โ  [MANUAL TRIGGER CHECK] Scan for status=1 scripts          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
              โโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ  executeManualScript()  โ
              โ  Check: status === 1?   โ
              โโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                         โ YES
                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Update status: 1 โ 2 (RUNNING)                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                    Run script.start()
                            โ
                    โโโโโโโโโโโโ
                    โ Success? โ
                    โโโโโโโโโโโโ
                   โ            โ
              โ YES           โ NO
                 โ               โ
โโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโ
โ Update status: 2 โ 0 โ  โ Update status: 2 โ -1โ
โ (SUCCESS)            โ  โ (ERROR)              โ
โโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโ
                 โ               โ
         Log execution history
```

---

## Status Lifecycle (Manual Execution Only)

```
     User Action          Status Value       Display
         โ                     โ                 โ
         โโ Clicks Button      โโโโโโโบ 1 โโโโโโโโคโโบ "Waiting to start"
         โ                     โ                 โ
         โโ Cron detects       โโโโโโโบ 2 โโโโโโโโคโโบ "In progress"
         โ                     โ                 โ
         โโ Success            โโโโโโโบ 0 โโโโโโโโคโโบ "Success" โ
         โ                     โ                 โ
         โโ Error              โโโโโโโบ -1 โโโโโโโโโบ "Error" โ
```

---

## Parallel Execution Example

```
Timeline:
12:00 AM  โ
          โ
 1:00 AM  โโโบ [SCHEDULED] midnight-1am cron fires
          โ   โโ synchroMandats
          โ   โโ synchroContratEntretien
          โ   โโ synchroSuiviVieCopro
          โ
 2:15 PM  โ
          โโโบ User clicks "Lancer Manuellement" on synchroFacture
          โ   โโ Status set to 1
          โ
 2:20 PM  โ
          โโโบ [MANUAL] every-5-minutes cron detects status=1
          โ   โโ synchroFacture executes manually
          โ
 3:00 AM  โ
          โโโบ [SCHEDULED] morning-sync-3am cron fires
          โ   โโ synchroFacture (automatic)
          โ   โโ zendeskTicket
          โ   โโ synchroRapelles
          โ
          
NOTE: synchroFacture runs TWICE:
  1. At 2:20 PM (manual trigger)
  2. At 3:00 AM (scheduled cron)
  
Both are independent and correct!
```

---

## Data Flow

### Automated Cron
```
CronConfig (MongoDB)
       โ
    Schedule
       โ
executeScheduledScript()
       โ
   script.start()
       โ
 Execution History
 (no status update)
```

### Manual Execution
```
  UI Button
      โ
 Status = 1
      โ
ScriptState (MongoDB)
      โ
every-5-minutes check
      โ
executeManualScript()
      โ
Status = 2 โ script.start() โ Status = 0/-1
      โ
Execution History
(with status updates)
```

---

## Configuration Files

```
Project Structure:

server/src/cron/
  โโ cronStart.js ................... Main orchestrator
  โ   โโ executeScheduledScript() ... Automated cron
  โ   โโ executeManualScript() ...... Manual trigger
  โ
  โโ synchroFacture.js .............. Individual scripts
  โโ zendeskTicket.js
  โโ [other scripts]

server/src/services/
  โโ scriptService.js ............... Script status management
  โโ cronConfigService.js ........... Cron configuration

server/src/controllers/
  โโ scriptController.js ............ API endpoints

MongoDB Collections:
  โโ CronConfig ..................... Cron schedules
  โโ ScriptState .................... Script status & history

front/src/containers/
  โโ script.js ...................... UI dashboard
```

---

## Logging Prefixes

```
[CRON]                  - General cron system messages
[SCHEDULED]             - Automated cron execution
[MANUAL]                - User-triggered execution
[MANUAL TRIGGER CHECK]  - 5-minute scan for status=1 scripts

Example Logs:
2025-11-23 03:00:00 [SCHEDULED] Executing script: synchroFacture
2025-11-23 03:00:15 [CRON] โ Script synchroFacture completed successfully

2025-11-23 14:20:00 [MANUAL TRIGGER CHECK] Scanning for user-triggered scripts (status=1)
2025-11-23 14:20:01 [MANUAL] Starting user-triggered script: zendeskTicket
2025-11-23 14:20:45 [MANUAL] โ Script zendeskTicket completed successfully
```

---

## Quick Reference

### Check Cron Status
```bash
curl http://localhost:8081/cron-config/
```

### Trigger Manual Execution
```bash
curl -X POST http://localhost:8081/script/update-status \
  -d '{"scriptName": "synchroFacture", "status": 1}'
```

### View Script Status
```bash
curl http://localhost:8081/script/
```

### Reload Cron Configurations
```bash
curl -X POST http://localhost:8081/cron-config/reload
```

---

## Decision Tree: Which System to Use?

```
                  โโโโโโโโโโโโโโโโโโโโโโโ
                  โ Need to run script? โ
                  โโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                  โโโโโโโโโโโโโโโโโโโโโโโ
                  โ When should it run? โ
                  โโโโโโโโโโโโโโโโโโโโโโโ
                       โ          โ
              On schedule      Right now
                   โ               โ
         โโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ
         โ Use CRON       โ  โ Use MANUAL   โ
         โ - Configure    โ  โ - Click      โ
         โ   schedule     โ  โ   button     โ
         โ - Set enabled  โ  โ - Wait 5 min โ
         โ - Reload cron  โ  โ              โ
         โโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ
                   โ               โ
         [SCHEDULED] logs    [MANUAL] logs
```

---

For complete details, see: **CRON_VS_MANUAL_EXECUTION.md**
